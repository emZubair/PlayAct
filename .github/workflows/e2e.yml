name: E2E Tests with Allure

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

# Cancel in-progress runs when a new commit is pushed to the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests
        id: playwright
        env:
          BASE_URL: https://play-act.vercel.app/
        run: |
          npm run test:e2e 2>&1 | tee playwright-output.txt
        continue-on-error: true

      - name: Generate Allure report
        if: always()
        run: |
          # Check if allure-results directory exists and has files
          if [ -d "allure-results" ] && [ "$(ls -A allure-results)" ]; then
            echo "Allure results found, generating report..."

            # Install Allure command line
            curl -o allure-2.24.1.tgz -Ls https://github.com/allure-framework/allure2/releases/download/2.24.1/allure-2.24.1.tgz
            tar -zxvf allure-2.24.1.tgz -C /opt/
            sudo ln -s /opt/allure-2.24.1/bin/allure /usr/bin/allure

            # Generate Allure report
            allure generate allure-results --clean -o allure-report

            echo "Allure report generated successfully"
          else
            echo "No allure-results found or directory is empty"
            mkdir -p allure-report
            echo "<html><body><h1>No test results available</h1></body></html>" > allure-report/index.html
          fi

      - name: Generate test summary
        if: always()
        id: summary
        run: |
          # Strip ANSI color codes from output file
          sed -i 's/\x1B\[[0-9;]*[JKmsu]//g' playwright-output.txt

          echo "## E2E Test Results Summary" > summary.md
          echo "" >> summary.md

          # Playwright results
          echo "### üé≠ Playwright E2E Tests" >> summary.md
          if grep -q "passed" playwright-output.txt; then
            TEST_RESULT=$(grep -E "[0-9]+ passed" playwright-output.txt | tail -1 | xargs)
            echo "‚úÖ **Status:** Passed" >> summary.md
            echo "\`\`\`" >> summary.md
            echo "$TEST_RESULT" >> summary.md
            echo "\`\`\`" >> summary.md
          else
            echo "‚ùå **Status:** Failed" >> summary.md
            echo "\`\`\`" >> summary.md
            tail -30 playwright-output.txt >> summary.md
            echo "\`\`\`" >> summary.md
          fi

          echo "" >> summary.md
          echo "---" >> summary.md
          echo "üìä **Allure Report:** Available on [GitHub Pages](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }})" >> summary.md

      - name: Comment PR with test results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('summary.md', 'utf8');

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('E2E Test Results Summary')
            );

            const commentBody = `${summary}\n\n_Updated: ${new Date().toUTCString()}_`;

            // Update or create comment
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

      - name: Deploy Allure report to GitHub Pages
        if: always() && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          keep_files: false
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'

      - name: Print deployment info
        if: always() && github.ref == 'refs/heads/main'
        run: |
          echo "‚úÖ Allure report should be deployed to GitHub Pages"
          echo "üìä Report URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          echo "‚ö†Ô∏è Note: If this is the first deployment, you need to enable GitHub Pages in repository settings:"
          echo "   Settings ‚Üí Pages ‚Üí Source: Deploy from branch ‚Üí Branch: gh-pages ‚Üí Folder: / (root)"

      - name: Fail workflow if tests failed
        if: steps.playwright.outcome == 'failure'
        run: exit 1
